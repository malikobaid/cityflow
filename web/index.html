<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CityFlow • Landing</title>
  <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="assets/css/site.css" />
    <!-- Scripts -->
  <script src="assets/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/alpine.min.js" defer></script>
  <script src="assets/js/app.js"></script>
  
  <script>
function chatStore(){
  return {
    messages: [], inputText: '', isSending: false, apiBaseUrl: '',
    init(){
      try {
        const KEY = 'cityflow.chat.history';
        let saved = [];
        try { saved = JSON.parse(localStorage.getItem(KEY)||'[]'); } catch {}
        this.messages = Array.isArray(saved) ? saved : [];
      } catch(_) {}

      // Use unified API base (auto-appends /v1 if missing)
      this.apiBaseUrl = (window.SK?.api?.baseV1 || '').trim();
      window.addEventListener('sk:config-ready', (e) => {
        const v1 = e?.detail?.api?.baseV1 || '';
        if (v1) this.apiBaseUrl = v1.trim();
      }, { once: true });
    },

    addUser(){
      const text = (this.inputText || '').trim();
      if (!text) return;
      this.messages.push({ id: crypto.randomUUID(), role:'user', content:text, ts:Date.now() });
      this.inputText = '';
      this.persist();
      this.sendToApi();
    },

  async sendToApi(){
  this.isSending = true;
  try {
    const resp = await fetch(`${this.apiBaseUrl}/chat`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ messages: this.messages.map(({role, content}) => ({role, content})) })
    });

    // Handle non-2xx early
    if (!resp.ok) {
      const txt = await resp.text().catch(()=> '');
      throw new Error(`HTTP ${resp.status} ${resp.statusText} ${txt}`);
    }

    const data = await resp.json().catch(()=> ({}));
    console.log('Chat API response:', data); // keep for debugging

    const reply = getAssistantReply(data);
    this.messages.push({
      id: crypto.randomUUID(),
      role: 'assistant',
      content: reply ?? '(mock) No content in reply',
      ts: Date.now()
    });

  } catch (err) {
    console.error('Chat API error:', err);
    this.messages.push({
      id: crypto.randomUUID(),
      role:'assistant',
      content: 'API error. See console for details.',
      ts: Date.now()
    });
  } finally {
    this.isSending = false;
    this.persist();
  }

  // helper next to your store or inside it
  function getAssistantReply(data){
    // expected shape
    if (data?.message?.content) return data.message.content;

    // common alternates
    if (typeof data?.reply === 'string') return data.reply;
    if (typeof data?.content === 'string') return data.content;
    if (typeof data?.text === 'string') return data.text;

    // OpenAI-style choices
    const choiceMsg = data?.choices?.[0]?.message?.content;
    if (choiceMsg) return choiceMsg;

    // messages array with last assistant
    const msgs = data?.messages;
    if (Array.isArray(msgs)) {
      const last = [...msgs].reverse().find(m => m.role === 'assistant') || msgs[msgs.length - 1];
      if (last?.content) return last.content;
    }

    // plain string payload
    if (typeof data === 'string') return data;

    // final fallback
    return JSON.stringify(data);
  }
},

    persist(){
      try { localStorage.setItem('cityflow.chat.history', JSON.stringify(this.messages)); } catch(_){}
    },

    clear(){
      this.messages = [];
      this.persist();
    }
  }
}
</script>


</head>
<body>
  <!-- Header injected at runtime -->
  <div id="site-header"></div>

  <main class="container py-4">
    <!-- Hero -->
    <section id="hero" class="py-4">
      <div class="row align-items-center g-4">
        <div class="col-lg-7">
          <h1 class="display-5 fw-semibold mb-3">Transport simulation demos</h1>
          <p class="lead text-muted mb-4">Configure a city slice, run agent based routing, and review results. This page includes a chatbot UI for guidance. API wiring will come later.</p>
          <div class="d-flex gap-2">
            <a class="btn btn-primary btn-lg" href="simulate.html">Run a simulation</a>
            <a class="btn btn-outline-secondary btn-lg" href="sim_results.html">View results</a>
          </div>
        </div>
<!--        <div class="col-lg-5">-->
<!--          <div class="alert alert-warning d-flex align-items-center" role="alert">-->
<!--            <div class="me-2">ℹ️</div>-->
<!--            <div>-->
<!--              You are in mock mode until an API base URL is configured. Use <code>config/site.json</code> to set <code>apiBaseUrl</code>.-->
<!--            </div>-->
<!--          </div>-->
<!--        </div>-->
      </div>
    </section>

    <!-- Chatbot panel -->
    <section id="chat-root" class="py-3" x-data="chatStore()" x-init="init()">

      <div class="row g-4">
        <div class="col-lg-7">
          <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span class="fw-semibold">Assistant</span>
              <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-outline-secondary" @click="clear()" :disabled="isSending">Clear</button>
              </div>
            </div>
            <div class="card-body" style="height: 380px; overflow-y: auto;" id="chat-messages" aria-live="polite">
              <template x-if="messages.length === 0">
                <div id="chat-empty" class="text-muted">No messages yet. Ask about how to set up a simulation or where to find results.</div>
              </template>

              <template x-for="m in messages" :key="m.id">
                <div class="mb-3">
                  <div class="small text-muted" x-text="new Date(m.ts).toLocaleTimeString()"></div>
                  <div class="p-3 rounded" :class="m.role==='user' ? 'bg-primary text-white' : 'bg-light'" x-text="m.content"></div>
                </div>
              </template>

              <template x-if="isSending">
                <div id="chat-typing" class="text-muted">Assistant is typing...</div>
              </template>
            </div>
            <div class="card-footer bg-white">
              <div class="input-group">
                <input id="chat-input" type="text" class="form-control" placeholder="Type your question..." x-model="inputText" @keydown.enter.prevent="addUser()" />
                <button id="chat-send" class="btn btn-primary" @click="addUser()" :disabled="isSending || !inputText.trim()">Send</button>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-5">
          <!-- Quick actions / info cards -->
          <div id="quick-actions" class="row g-3">
            <div class="col-12">
              <div class="card h-100">
                <div class="card-body">
                  <h5 class="card-title">Start with presets</h5>
                  <p class="card-text">Jump to popular areas and defaults for quick runs. You can tweak everything later.</p>
                  <a href="simulate.html#presets" class="btn btn-outline-primary btn-sm">Open presets</a>
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="card h-100">
                <div class="card-body">
                  <h5 class="card-title">How it works</h5>
                  <p class="card-text">A static UI that will call serverless APIs for job submission, status, and chat.</p>
                  <a href="docs/api.html" class="btn btn-outline-secondary btn-sm">View API contract</a>
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="card h-100">
                <div class="card-body">
                  <h5 class="card-title">Latest updates</h5>
                  <p class="card-text">See recent changes in the repo and deployment notes.</p>
                  <a href="https://github.com/malikobaid" class="btn btn-outline-secondary btn-sm" target="_blank" rel="noopener">GitHub</a>
                </div>
              </div>
            </div>
          </div>

          <!-- Recent job shortcut -->
          <div id="recent-jobs" class="card mt-3" x-data="{ lastId: localStorage.getItem('last_job_id') || '' }">
            <div class="card-body d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-semibold">Recent job</div>
                <div class="text-muted small" x-text="lastId ? lastId : 'No recent jobs yet' "></div>
              </div>
              <a class="btn btn-sm btn-primary" :class="!lastId && 'disabled'" :href="lastId ? ('sim_results.html?job_id=' + encodeURIComponent(lastId)) : '#'">Open</a>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer injected at runtime -->
  <div id="site-footer"></div>
</body>
</html>
